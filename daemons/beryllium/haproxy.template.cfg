global
    log /dev/log	local0
    log /dev/log	local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log	global
    timeout connect 5000
    timeout client  50000
    timeout server  50000

frontend frontend_http
    bind :80
    mode tcp
    {{ range $name, $ip := . -}}
    use_backend backend_http_site_{{ $name | replaceWithUnderscores }} if { hdr(host) -i {{ $name }} }
    {{ end }}

frontend frontend_http_alt
    bind :8080
    mode tcp
    {{ range $name, $ip := . -}}
    use_backend backend_http_alt_site_{{ $name | replaceWithUnderscores }} if { hdr(host) -i {{ $name }} }
    {{ end }}

frontend frontend_https
    bind :443
    mode tcp
    tcp-request inspect-delay 3s
    tcp-request content accept if { req_ssl_hello_type 1 }
    {{ range $name, $ip := . -}}
    use_backend backend_https_site_{{ $name | replaceWithUnderscores }} if { req.ssl_sni -i {{ $name }} }
    {{ end }}

frontend frontend_https_alt
    bind :8443
    mode tcp
    tcp-request inspect-delay 3s
    tcp-request content accept if { req_ssl_hello_type 1 }
    {{ range $name, $ip := . -}}
    use_backend backend_https_alt_site_{{ $name | replaceWithUnderscores }} if { req.ssl_sni -i {{ $name }} }
    {{ end }}

{{ range $name, $ip := . }}
backend backend_http_site_{{ $name | replaceWithUnderscores }}
    mode tcp
    server main [{{ $ip }}]:80
{{ end -}}

{{ range $name, $ip := . }}
backend backend_https_site_{{ $name | replaceWithUnderscores }}
    mode tcp
    server main [{{ $ip }}]:443
{{ end -}}

{{ range $name, $ip := . }}
backend backend_http_alt_site_{{ $name | replaceWithUnderscores }}
    mode tcp
    server main [{{ $ip }}]:8080
{{ end -}}

{{ range $name, $ip := . }}
backend backend_https_alt_site_{{ $name | replaceWithUnderscores }}
    mode tcp
    server main [{{ $ip }}]:8443
{{ end -}}