load_module /usr/lib/nginx/modules/ngx_stream_module.so;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

events {
    worker_connections 1024;
}


stream {  
  map $ssl_preread_server_name $targetBackendSSL {
{{ range $name, $ip := . -}}
    {{$name}} [{{$ip}}]:443;
{{ end }}
  }   
 
  server {
    listen 443; 
        
    proxy_connect_timeout 1s;
    proxy_timeout 3s;
    resolver 1.1.1.1;
    
    proxy_pass $targetBackendSSL;       
    ssl_preread on;
  }
}

http {
  map $host $upstream {
{{ range $name, $ip := . -}}
    {{$name}} [{{$ip}}]:80;
{{ end }}
  }   

  server {
    listen 80; 
    server_name _;
    location / {
	    proxy_redirect off;
	    proxy_set_header Host $host;
	    proxy_set_header X-Real-IP $remote_addr;
	    proxy_set_header X-Forwared-For $proxy_add_x_forwarded_for;
	    proxy_buffering off;
	    proxy_pass http://$upstream$uri;       
    }    
  }
}
